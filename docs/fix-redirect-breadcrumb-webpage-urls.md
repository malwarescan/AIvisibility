# Fix for Redirect Issues: Breadcrumb and Webpage URLs

## Problem

Google Search Console was reporting 1,469 pages with redirect issues. Analysis of the affected URLs revealed a pattern of malformed URLs with `/breadcrumb` or `/webpage` appended as path segments instead of fragment identifiers:

- `http://nrlcmd.com/services/schema-optimizer/rochester-ny/webpage`
- `http://nrlcmd.com/ai-consulting/spokane-2/breadcrumb`
- `http://nrlcmd.com/services/chatgpt-seo/chicago-il/breadcrumb/webpage/breadcrumb`

## Root Cause

The `nc_id()` function in `lib/schema_utils.php` was incorrectly stripping the `#` character from fragment identifiers. When called with `'#breadcrumb'` or `'#webpage'`, it would:

1. Strip the `#` character using `ltrim($suffix, '#')`
2. Append the result as a path segment: `https://nrlcmd.com/services/page/breadcrumb`
3. Instead of creating a proper fragment identifier: `https://nrlcmd.com/services/page/#breadcrumb`

This caused Google to crawl these invalid URLs, which then redirected to canonical versions, creating the redirect issue.

## Solution

### 1. Fixed `nc_id()` Function

**File:** `lib/schema_utils.php`

Changed the function to preserve fragment identifiers:

```php
if (!function_exists('nc_id')) {
  function nc_id(string $suffix): string {
    // Preserve fragment identifiers (they must start with #)
    // Append suffix as-is - don't strip # characters
    return nc_page_url().$suffix;
  }
}
```

Now `nc_id('#breadcrumb')` correctly returns `https://nrlcmd.com/services/page/#breadcrumb` instead of `https://nrlcmd.com/services/page/breadcrumb`.

### 2. Added Redirect Handling

**File:** `index.php`

Added logic to catch and redirect existing malformed URLs:

```php
// Redirect malformed URLs with /breadcrumb or /webpage appended
// These were incorrectly generated by the old nc_id() function that stripped # from fragment identifiers
// Examples: /services/schema-optimizer/rochester-ny/webpage -> /services/schema-optimizer/rochester-ny/
if (preg_match('#/(breadcrumb|webpage)(/|$)#', $path)) {
  // Remove all instances of /breadcrumb and /webpage from the end of the path
  $cleanPath = preg_replace('#/(breadcrumb|webpage)+(/|$)#', '/', $path);
  $cleanPath = rtrim($cleanPath, '/') ?: '/';
  $canonicalUrl = Canonical::absolute($cleanPath);
  header('Location: '.$canonicalUrl, true, 301);
  exit;
}
```

This ensures that any existing malformed URLs in Google's index will be properly redirected to their canonical versions with a 301 (permanent redirect) status.

## Impact

- **Immediate:** New JSON-LD schema IDs will use correct fragment identifiers (`#breadcrumb`, `#webpage`)
- **Ongoing:** Existing malformed URLs will redirect to canonical versions
- **Long-term:** As Google re-crawls, it will update its index with the correct URLs, resolving the redirect issues

## Testing

To verify the fix:

1. Check that JSON-LD output now includes proper fragment identifiers:
   ```bash
   curl -s https://nrlcmd.com/services/agentic-seo/new-york-ny/ | grep -o 'https://[^"]*#breadcrumb'
   ```
   Should return: `https://nrlcmd.com/services/agentic-seo/new-york-ny/#breadcrumb`

2. Verify redirect handling works:
   ```bash
   curl -I https://nrlcmd.com/services/agentic-seo/new-york-ny/breadcrumb
   ```
   Should return: `HTTP/1.1 301 Moved Permanently` with `Location: https://nrlcmd.com/services/agentic-seo/new-york-ny/`

## Timeline

- **2025-12-21:** Issue identified from Google Search Console coverage report
- **2025-12-21:** Root cause analysis completed
- **2025-12-21:** Fix implemented

## Related Files

- `lib/schema_utils.php` - Fixed `nc_id()` function
- `index.php` - Added redirect handling for malformed URLs
- `templates/head.php` - Uses `nc_id()` for schema IDs

